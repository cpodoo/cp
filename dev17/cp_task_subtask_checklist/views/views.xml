<?xml version="1.0" encoding="utf-8"?>
<odoo>

	<record id="view_project_task_tree_custom" model="ir.ui.view">
	    <field name="name">project.task.tree.custom</field>
	    <field name="model">project.task</field>
	    <field name="inherit_id" ref="project.view_task_tree2"/>
	    <field name="arch" type="xml">
	        <xpath expr="//field[@name='stage_id']" position="after">
			    <field name="checklist_id" invisible="0"/>
			    <field name="activity_progress" widget="progressbar" invisible="not checklist_id"/>
			</xpath>
	    </field>
	</record>
	
	<record id="view_project_task_kanban_custom" model="ir.ui.view">
	    <field name="name">project.task.kanban.custom</field>
	    <field name="model">project.task</field>
	    <field name="inherit_id" ref="project.view_task_kanban"/>
	    <field name="arch" type="xml">
	        <xpath expr="//field[@name='project_id']" position="after">
	            <field name="checklist_id"/>
	            <field name="activity_progress"/>
	        </xpath>
	        <xpath expr="//div[@class='oe_kanban_bottom_right']" position="before">
	            <div t-if="record.checklist_id.raw_value">
	                <field name="activity_progress" widget="percentpie" nolabel="1"/>
	            </div>
	        </xpath>
	    </field>
	</record>
	
	<record id="view_task_form_custom" model="ir.ui.view">
	    <field name="name">project.task.form.custom</field>
	    <field name="model">project.task</field>
	    <field name="inherit_id" ref="project.view_task_form2"/>
	    <field name="arch" type="xml">
	        <xpath expr="//field[@name='tag_ids']" position="after">
	            <field name="checklist_id"
	                   options="{'no_create': True, 'no_open': False}"
	                   context="{'default_project_id': project_id}"/>
	        </xpath>

	        <notebook position="inside">
	            <page string="Checklist" invisible="not checklist_id">
	                <field name="checklist_activity_ids">->
	                    <tree decoration-danger="canceled==True" decoration-success="completed==True"
	                          decoration-info="progress==True" create="1" edit="1" delete="0">
	                        <field name="sequence" widget="handle"/>
	                        <field name="name"/>
	                        <field name="description"/>
	                        <field name="approve_user_id"/>
	                        <field name="completed" column_invisible="True"/>
	                        <field name="canceled" column_invisible="True"/>
	                        <field name="progress" column_invisible="True"/>
	                        <field name="default_stage" column_invisible="True"/>
	                        <field name="can_reset_after_completed" column_invisible="True"/>
	                        <field name="can_reset_after_canceled" column_invisible="True"/>
	                        <button type="object" name="approve_and_next_stage" icon="fa-check" class="text-success"
	                                string="Approve and Next Stage"
	                                invisible="default_stage in ['Completed', 'Canceled']"/>
	                        <button type="object" name="mark_completed" icon="fa-check-circle" class="text-success"
	                                string="Mark Completed"
	                                invisible="default_stage in ['Completed', 'Canceled']"/>
	                        <button type="object" name="mark_canceled" icon="fa-times" class="text-danger" string="Mark Canceled"
	                                invisible="default_stage in ['Completed', 'Canceled']"/>
	                        <button type="object" name="reset_todo" icon="fa-undo" class="text-warning" string="Reset State"
	                                invisible="(default_stage != 'Canceled' or not can_reset_after_canceled) or (default_stage != 'Completed' or not can_reset_after_completed)"/>
	                        <field name="activity_stage_id"/>
	                    </tree>
	                    <form string="Activity">
	                        <header>
	                            <button type="object" name="approve_and_next_stage" class="text-success" string="Approve And Next Stage"
	                                    icon="fa-check" invisible="default_stage in ['Completed', 'Canceled']"/>
	                            <button type="object" name="mark_completed" icon="fa-check-circle" class="text-success"
	                                    string="Mark Completed" invisible="default_stage in ['Completed', 'Canceled']"/>
	                            <button type="object" name="mark_canceled" icon="fa-times" class="text-danger" string="Mark Canceled"
	                                    invisible="default_stage in ['Completed', 'Canceled']"/>
	                            <button type="object" name="reset_todo" icon="fa-undo" class="text-warning" string="Reset State"
	                                    invisible="(default_stage != 'Canceled' or not can_reset_after_canceled) or (default_stage != 'Completed' or not can_reset_after_completed)"/>
	                            <field name="activity_stage_id" widget="statusbar"/>
	                        </header>
	                        <group col="4">
	                            <field name="name"/>
	                            <field name="approve_user_id"/>
	                            <field name="description"/>
	                            <field name="default_stage" invisible="1"/>
	                            <field name="can_reset_after_completed" invisible="1"/>
	                            <field name="can_reset_after_canceled" invisible="1"/>
	                            <field name="task_id" invisible="1"/>
	                            <field name="project_id" invisible="1"/>
	                        </group>
	                    </form>
	                </field>
	                <div class="mt-3 text-center"> 
                     	<field name="activity_progress" widget="gauge"/>
                	</div>
	            </page>
	        </notebook>
	    </field>
	</record>
	
	<record id="view_project_task_form_inherit_readonly_checklist_id" model="ir.ui.view">
	    <field name="name">project.task.form.inherit.readonly.checklist_id</field>
	    <field name="model">project.task</field>
	    <field name="inherit_id" ref="project.view_task_tree2"/>
	    <field name="arch" type="xml">
	        <xpath expr="//field[@name='checklist_id']" position="attributes">
	            <attribute name="readonly">False</attribute>
	        </xpath>
	    </field>
	</record>

	<record id="view_task_type_edit_checklist" model="ir.ui.view">
	    <field name="name">project.task.type.checklist.form</field>
	    <field name="model">project.task.type</field>
	    <field name="inherit_id" ref="project.task_type_edit"/>
	    <field name="arch" type="xml">
	        <xpath expr="//field[@name='fold']" position="after">
			    <field name="checklist_task_progress_restriction" groups="cp_task_subtask_checklist.group_checklist_task_progress_restriction"/>
			</xpath>
	    </field>
	</record>

    <record id="view_checklist_form" model="ir.ui.view">
            <field name="name">task.checklist.form</field>
            <field name="model">task.checklist</field>
            <field name="arch" type="xml">
                <form string="Task Checklist Template">
                    <sheet>
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1><field name="name" placeholder="e.g. New Server Setup Checklist"/></h1>
                        </div>
                        <group>
                            <group>
                                <field name="project_id"/>
                            </group>
                            <group>
                                <field name="description" placeholder="Description of the checklist purpose..."/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Checklist Items" name="checklist_items">
                                <field name="item_ids" widget="one2many_list">
                                    <tree editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="name"/>
                                        <field name="description"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>
	
	<record id="view_checklist_tree" model="ir.ui.view">
	    <field name="name">task.checklist.tree</field>
	    <field name="model">task.checklist</field>
	    <field name="arch" type="xml">
	        <tree>
	            <field name="name"/>
	            <field name="project_id"/>
	            <field name="description"/>
	        </tree>
	    </field>
	</record>
	
	<record id="view_checklist_filter" model="ir.ui.view">
	    <field name="name">task.checklist.search</field>
	    <field name="model">task.checklist</field>
	    <field name="arch" type="xml">
	        <search string="Checklists">
	            <field name="name"/>
	            <field name="project_id"/>
	            <field name="description"/>
	            <group expand="0" string="Group By">
	                <filter name="group_project_id" string="Project" domain="[]" context="{'group_by':'project_id'}"/>
	            </group>
	        </search>
	    </field>
	</record>
	
	<record id="action_checklist_tree" model="ir.actions.act_window">
	    <field name="name">Task Checklist</field>
	    <field name="res_model">task.checklist</field>
	    <field name="view_mode">tree,form</field>
	</record>
	
	
	<record id="checklist_activity_stages_form" model="ir.ui.view">
	    <field name="name">checklist.activity.stages.form</field>
	    <field name="model">checklist.activity.stages</field>
	    <field name="arch" type="xml">
	        <form string="Checklist Activity Stages">
	            <sheet>
	                <div class="oe_title">
	                    <h2 class="o_row">
	                        <field name="name" required="1" placeholder="Stage Name"/>
	                    </h2>
	                </div>
	                <group colspan="4" col="4">
	                    <field name="sequence"/>
	                    <field name="default_stage" readonly="1"/>
	                </group>
	            </sheet>
	        </form>
	    </field>
	</record>
	
	<record id="checklist_activity_stages_tree" model="ir.ui.view">
	    <field name="name">checklist.activity.stages.tree</field>
	    <field name="model">checklist.activity.stages</field>
	    <field name="arch" type="xml">
	        <tree>
	            <field name="name"/>
	            <field name="sequence"/>
	            <field name="default_stage"/>
	        </tree>
	    </field>
	</record>
	
	<record id="action_checklist_activity_stages" model="ir.actions.act_window">
	    <field name="name">Checklist Activity Stages</field>
	    <field name="res_model">checklist.activity.stages</field>
	    <field name="view_mode">tree,form</field>
	</record>
	
	
	<record id="checklist_activities_form" model="ir.ui.view">
	    <field name="name">checklist.activities.form</field>
	    <field name="model">checklist.activities</field>
	    <field name="arch" type="xml">
	        <form string="Checklist Activities">
	            <header>
	                <button type="object" name="approve_and_next_stage" class="text-success" string="Approve and Next Stage"
	                        icon="fa-check" invisible="default_stage in ['Completed', 'Canceled']"/>
	                <button type="object" name="mark_completed" icon="fa-check-circle" class="text-success"
	                        string="Mark Completed" invisible="default_stage in ['Completed', 'Canceled']"/>
	                <button type="object" name="mark_canceled" icon="fa-times" class="text-danger" string="Mark Canceled"
	                        invisible="default_stage in ['Completed', 'Canceled']"/>
	                <button type="object" name="reset_todo" icon="fa-undo" class="text-warning" string="Reset State"
	                        invisible="(default_stage != 'Canceled' or not can_reset_after_canceled) or (default_stage != 'Completed' or not can_reset_after_completed)"/>
	                <field name="activity_stage_id" widget="statusbar"/>
	            </header>
	            <sheet>
	                <group col="4">
	                    <field name="name"/>
	                    <field name="task_id" readonly="1" force_save="1"/>
	                    <field name="project_id" readonly="1" force_save="1"/>
	                    <field name="approve_user_id"/>
	                    <field name="description"/>
	                    <field name="default_stage" invisible="1"/>
	                    <field name="can_reset_after_completed" invisible="1"/>
	                    <field name="can_reset_after_canceled" invisible="1"/>
	                </group>
	            </sheet>
	            <chatter/>
	        </form>
	    </field>
	</record>
	
	<record id="checklist_activities_tree" model="ir.ui.view">
	    <field name="name">checklist.activities.tree</field>
	    <field name="model">checklist.activities</field>
	    <field name="arch" type="xml">
	        <tree decoration-danger="canceled==True" decoration-success="completed==True" decoration-info="progress==True" create="1" edit="1" delete="0" string="Activity">
	            <field name="sequence" widget="handle"/>
	            <field name="name"/>
	            <field name="task_id"/>
	            <field name="project_id"/>
	            <field name="approve_user_id"/>

	            <field name="completed" invisible="0"/>
	            <field name="canceled" invisible="0"/>
	            <field name="progress" invisible="0"/>
	            <field name="default_stage" invisible="0"/>
	            <field name="can_reset_after_completed" invisible="0"/>
	            <field name="can_reset_after_canceled" invisible="0"/>

	            <button type="object" name="approve_and_next_stage" class="text-success" string="Approve And Next Stage"
	                    icon="fa-check" invisible="default_stage in ['Completed', 'Canceled']"/>
	            <button type="object" name="mark_completed" icon="fa-check-circle" class="text-success"
	                    string="Mark Completed" invisible="default_stage in ['Completed', 'Canceled']"/>
	            <button type="object" name="mark_canceled" icon="fa-times" class="text-danger" string="Mark Canceled"
	                    invisible="default_stage in ['Completed', 'Canceled']"/>
	            <button type="object" name="reset_todo" icon="fa-undo" class="text-warning" string="Reset State"
	                    invisible="(default_stage == 'Canceled' and not can_reset_after_canceled) and (default_stage == 'Completed' and not can_reset_after_completed)"/>
	            <field name="activity_stage_id"/>
	        </tree>
	    </field>
	</record>

    <record id="view_checklist_activities_filter" model="ir.ui.view">
        <field name="name">checklist.activities.search</field>
        <field name="model">checklist.activities</field>
        <field name="arch" type="xml">
            <search string="Checklist Activity">
                <field name="name"/>
                <field name="task_id"/>
                <field name="project_id"/>
                <field name="approve_user_id"/>
                <field name="activity_stage_id"/>
                <separator/>
                <filter string="TODO" name="activity_TODO"
                        domain="[('activity_stage_id.default_stage','=','TODO')]"/>
                <filter string="Completed" name="activity_Completed"
                        domain="[('activity_stage_id.default_stage','=','Completed')]"/>
                <filter string="Canceled" name="activity_Canceled"
                        domain="[('activity_stage_id.default_stage','=','Canceled')]"/>
                <filter string="Custom Stage" name="activity_Custom"
                        domain="[('activity_stage_id.default_stage','not in', ('TODO','Completed','Canceled'))]"/>
                <separator/>
                <group expand="0" string="Group By">
                    <filter name="group_stage" string="Stage"
                            context="{'group_by':'activity_stage_id'}"/>
                    <filter name="group_task" string="Task"
                            context="{'group_by':'task_id'}"/>
                    <filter name="group_project" string="Project"
                            context="{'group_by':'project_id'}"/>
                    <filter name="group_approve_user" string="Approver"
                            context="{'group_by':'approve_user_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="action_checklist_activities" model="ir.actions.act_window">
        <field name="name">Checklist Activities</field>
        <field name="res_model">checklist.activities</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{
            'search_default_approve_user_id': uid,
            'stage_type': 'claim'}
        </field>
    </record>

    <record id="act_project_checklist_activities" model="ir.actions.act_window">
        <field name="name">Checklist Activities</field>
        <field name="res_model">checklist.activities</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{
            'search_default_project_id': active_id,
            'default_project_id': active_id
        }</field>
        <field name="search_view_id" ref="view_checklist_activities_filter"/>
    </record>

    <record id="view_project_project_kanban_custom" model="ir.ui.view">
        <field name="name">project.project.kanban.custom</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.view_project_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@class='oe_kanban_bottom_right']" position="inside">
                <a name="%(cp_task_subtask_checklist.act_project_checklist_activities)d" type="action"
                   class="o_project_kanban_box"
                   t-if="record.activity_count.raw_value > 0"
                   title="Checklist Activities">
                    <field name="activity_count" invisible="1"/>
                    <span class="o_value"><t t-out="record.activity_count.raw_value"/></span>
                    <span class="o_label">Checklist Activities</span>
                </a>
            </xpath>
        </field>
    </record>
	
	<record id="view_edit_project_custom" model="ir.ui.view">
	    <field name="name">project.project.form.custom</field>
	    <field name="model">project.project</field>
	    <field name="inherit_id" ref="project.edit_project"/>
	    <field name="arch" type="xml">
	        <xpath expr="//header/button[@name='%(project.project_share_wizard_action)d']" position="after">
			    <button class="oe_inline oe_stat_button" type="action"
			            name="%(act_project_checklist_activities)d" icon="fa-list-alt">
			        <field string="Activities" name="activity_count" widget="statinfo"/>
			    </button>
			</xpath>
	    </field>
	</record> 
	
	<menuitem id="menu_action_view_task" name="Checklist Activities" sequence="15"
	          parent="project.menu_main_pm" action="action_checklist_activities"/>
	<menuitem id="menu_config_checklist" name="Checklist" parent="project.menu_project_config" sequence="30"/>
	<menuitem id="menu_checklist" name="Task Checklist" sequence="30" parent="menu_config_checklist" action="action_checklist_tree"/>
	<menuitem id="menu_checklist_activity_stages" name="Checklist Activity Stages" sequence="31"
	          parent="menu_config_checklist" action="action_checklist_activity_stages"/>

</odoo>
